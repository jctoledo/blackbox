<!DOCTYPE html>
<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="default"><title>Blackbox</title>
<style>
:root{
    /* Spacing scale (4px base) */
    --sp-xs:4px;
    --sp-sm:8px;
    --sp-md:12px;
    --sp-lg:16px;
    --sp-xl:24px;
    --sp-2xl:32px;

    /* Typography scale */
    --fs-xs:10px;
    --fs-sm:12px;
    --fs-md:18px;
    --fs-lg:22px;

    /* Opacity scale */
    --op-muted:0.45;

    /* Colors */
    --bg:#f2f2f7;
    --surface:#ffffff;
    --text:#1c1c1e;
    --text-secondary:#48484a;
    --text-tertiary:#8e8e93;
    --divider:rgba(0,0,0,.08);
    --ok:#34c759;
    --amber:#ff9500;
    --red:#ff3b30;
    --mode-idle:#8e8e93;
    --mode-accel:#1c1c1e;
    --mode-brake:#ff3b30;
}
.dark{
    --bg:#000000;
    --surface:#2c2c2e;
    --text:#ffffff;
    --text-secondary:#aeaeb2;
    --text-tertiary:#636366;
    --divider:rgba(255,255,255,.08);
    --mode-idle:#636366;
    --mode-accel:#ffffff;
    --mode-brake:#ff3b30;
}
*{margin:0;padding:0;box-sizing:border-box}

/* iPhone 15 Pro frame */
html,body{height:100%;overflow:hidden}
body{
    font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','SF Pro Display',system-ui,sans-serif;
    background:#1a1a1a;
    display:flex;
    align-items:center;
    justify-content:center;
}
.bbDeviceFrame{
    width:393px;
    height:852px;
    background:#1a1a1a;
    border-radius:55px;
    padding:11px;
    box-shadow:inset 0 0 0 3px #333;
    position:relative;
}
.bbDeviceFrame::before{
    content:'';
    position:absolute;
    top:11px;
    left:50%;
    transform:translateX(-50%);
    width:126px;
    height:37px;
    background:#1a1a1a;
    border-radius:0 0 24px 24px;
    z-index:10;
}
.bbDeviceScreen{
    width:100%;
    height:100%;
    border-radius:44px;
    overflow:hidden;
    background:var(--bg);
    color:var(--text);
    display:flex;
    flex-direction:column;
    -webkit-user-select:none;
    user-select:none;
    transition:background 0.3s ease-in-out,color 0.3s ease-in-out;
}

/* ============================================
   CLEAN RESET: bb-prefixed classes only
   ============================================ */

.bbNum{
    font-variant-numeric:tabular-nums;
    font-feature-settings:"tnum" 1,"lnum" 1;
}

/* HEADER */
.bbTopbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:0 var(--sp-lg) var(--sp-xs);
    background:transparent;
    flex-shrink:0;
}
.bbBrandToggle{
    background:none;
    border:0;
    padding:0;
    display:flex;
    align-items:baseline;
    gap:var(--sp-sm);
    cursor:pointer;
    color:inherit;
    font-family:inherit;
}
.bbBrand{font-size:var(--fs-sm);font-weight:600;opacity:.45;letter-spacing:.03em}
.bbModeLabel{font-size:var(--fs-sm);font-weight:400;opacity:.45;letter-spacing:.03em}
.bbModeIcon{font-size:var(--fs-xs);opacity:.45}
.bbTopRight{
    display:flex;
    align-items:center;
    gap:var(--sp-md);
}
.bbStatusCluster{
    display:flex;
    align-items:center;
    gap:var(--sp-md);
    opacity:.45;
    font-size:var(--fs-xs);
    letter-spacing:.03em;
}
.bbStatusItem{display:flex;align-items:center;gap:var(--sp-xs)}
.bbStatusItem .bbHigh{margin-right:1px}
.bbDot{width:6px;height:6px;border-radius:50%;background:var(--ok);display:inline-block}
.bbHigh{color:var(--ok);font-weight:600}
.bbKebab{background:none;border:0;padding:var(--sp-xs);font-size:var(--fs-md);line-height:1;opacity:.45;cursor:pointer;color:inherit}

/* APP CONTAINER */
.bbApp{
    flex:1;
    display:flex;
    flex-direction:column;
    padding:0 var(--sp-md) var(--sp-xs);
    min-height:0;
}

/* CARD */
.bbCard{
    background:var(--surface);
    border-radius:var(--sp-lg);
    overflow:hidden;
}
.bbGCard{
    display:flex;
    flex-direction:column;
    width:100%;
}

/* TOP READOUT ROW (Mode/Speed) */
.bbGReadoutRow--top{
    padding:var(--sp-xl) var(--sp-lg) var(--sp-sm);
    align-items:center;
    justify-content:space-between;
    gap:20%;
}
.bbGReadoutRow--top .bbGReadoutCol{
    flex:1;
    width:50%;
}
.bbGReadoutRow--top .bbGReadoutCol:first-child{
    align-items:flex-end;
}
.bbGReadoutRow--top .bbGReadoutCol:last-child{
    align-items:flex-start;
    min-height:2.4em;
}
.bbGReadoutRow--top .bbGReadoutVal{
    margin-top:0;
}
.bbGReadoutRow--top .bbMaxRow{
    margin-top:var(--sp-xs);
}
.bbManeuver{font-weight:600;font-size:14px;transition:color 0.15s ease-in-out;line-height:1.3;text-align:left !important;justify-content:flex-start !important;align-items:flex-start !important;min-height:2.6em;width:100%}
#speed{transition:color 0.6s ease-in-out}
#speed.peak{color:var(--amber)}
#max-speed{transition:color 0.6s ease-in-out}
#max-speed.setting{color:var(--amber);font-weight:400;font-style:italic}

/* PLOT AREA */
.bbGPlotWrap{
    display:flex;
    justify-content:center;
    padding:var(--sp-md) 0;
}
.bbGPlotFrame{
    position:relative;
    width:100%;
    aspect-ratio:1/1;
}
.bbGPlot{
    display:block;
    width:100%;
    height:100%;
}

/* AXIS LABELS */
.bbAxis{
    position:absolute;
    font-size:var(--fs-xs);
    font-weight:400;
    letter-spacing:.02em;
    text-transform:uppercase;
    opacity:.45;
    color:var(--text);
    pointer-events:none;
}
.bbAxis--top{top:var(--sp-xs);left:50%;transform:translateX(-50%)}
.bbAxis--bottom{bottom:var(--sp-xs);left:50%;transform:translateX(-50%)}
.bbAxis--left{left:var(--sp-sm);top:50%;transform:translateY(-50%)}
.bbAxis--right{right:var(--sp-sm);top:50%;transform:translateY(-50%)}

.bbPlotMeta{
    position:absolute;
    top:var(--sp-xs);
    right:var(--sp-sm);
    font-size:var(--fs-xs);
    color:var(--text);
    opacity:.45;
}

/* READOUT ROW */
.bbGReadoutRow{
    display:flex;
    justify-content:center;
    align-items:flex-start;
    gap:0;
    padding:var(--sp-md) var(--sp-lg) var(--sp-lg);
    flex-shrink:0;
}
.bbGReadoutCol{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
}
.bbGReadoutLbl{
    font-size:var(--fs-xs);
    font-weight:400;
    letter-spacing:.02em;
    text-transform:uppercase;
    opacity:.45;
    color:var(--text);
}
.bbGReadoutVal{
    margin-top:var(--sp-lg);
    font-size:var(--fs-lg);
    font-weight:600;
    line-height:1.0;
    min-width:6ch;
    display:inline-flex;
    align-items:baseline;
    justify-content:center;
    gap:1px;
    transition:color 0.6s ease-in-out;
}
.bbGReadoutVal.peak{color:var(--amber)}
.bbSign{display:inline-block;width:1ch;text-align:right;opacity:.45;margin-right:1px;font-weight:400}
.bbGUnit{opacity:.45;margin-left:1px;font-weight:400}
.bbGDivider{
    width:1px;
    height:56px;
    background:var(--divider);
    margin:0 var(--sp-sm);
    flex-shrink:0;
}
.bbMaxRow{
    display:flex;
    justify-content:center;
    gap:var(--sp-md);
    margin-top:var(--sp-sm);
}
.bbMaxItem{
    display:flex;
    align-items:baseline;
    gap:1px;
}
.bbMaxVal{font-size:var(--fs-sm);font-weight:500;opacity:.45;transition:color 0.6s ease-in-out}
.bbMaxVal.setting{color:var(--amber);font-weight:400;font-style:italic;opacity:1}
.bbMaxSign{font-size:var(--fs-sm);font-weight:500;opacity:.45;transition:opacity 0.6s ease-in-out}
.bbMaxSign.hidden{opacity:0}
.bbMaxLbl{font-size:var(--fs-sm);font-weight:400;opacity:.45;margin-left:var(--sp-xs)}
.bbYawPad{opacity:.45}

/* TELEMETRY STRIP */
.bbTelemetryStrip{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:var(--sp-lg);
    padding:var(--sp-md) 0;
    font-size:var(--fs-xs);
    font-weight:400;
    color:var(--text);
    opacity:.45;
    flex-shrink:0;
}
.bbTCluster{
    display:flex;
    align-items:baseline;
    gap:var(--sp-sm);
}
.bbTDivider{
    width:1px;
    height:12px;
    background:var(--divider);
}

/* CLEAR BUTTON */
.bbClearBtn{
    display:flex;
    align-items:center;
    justify-content:center;
    width:100%;
    height:44px;
    flex-shrink:0;
    margin-top:auto;
    font-family:inherit;
    font-size:var(--fs-sm);
    font-weight:500;
    text-align:center;
    color:var(--red);
    background:rgba(255,59,48,0.22);
    border:none;
    border-radius:var(--sp-md);
    cursor:pointer;
    transition:opacity 0.15s ease-in-out;
}
.bbClearBtn:active{
    opacity:0.6;
}

/* iOS STATUS BAR */
.bbStatusBar{
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    padding:var(--sp-xs) var(--sp-xl) var(--sp-xs);
    height:52px;
    font-size:var(--fs-sm);
    font-weight:600;
    flex-shrink:0;
}
.bbStatusBar__left{
    display:flex;
    align-items:center;
    gap:var(--sp-xs);
}
.bbStatusBar__center{
    flex:1;
}
.bbStatusBar__right{
    display:flex;
    align-items:center;
    gap:var(--sp-sm);
    font-size:var(--fs-xs);
}
.bbStatusBar__right svg{
    width:20px;
    height:12px;
    fill:currentColor;
}

/* iOS HOME INDICATOR */
.bbHomeIndicator{
    display:flex;
    justify-content:center;
    padding:var(--sp-sm) 0 var(--sp-md);
    flex-shrink:0;
}
.bbHomeIndicator__bar{
    width:134px;
    height:5px;
    background:var(--text);
    border-radius:3px;
    opacity:0.25;
}
.bbTItem{display:flex;align-items:baseline;gap:var(--sp-xs)}
.bbTItem .bbNum{font-weight:500;display:inline-block;text-align:right}
.bbNum--hz{min-width:2.5ch}
.bbNum--gps{min-width:2ch}
.bbNum--drops{min-width:2ch}
.bbNum--yaw{min-width:3ch}

/* MENU */
.bbMenuOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.25);
    opacity:0;
    visibility:hidden;
    transition:opacity 0.15s ease-in-out;
    z-index:100;
}
.dark .bbMenuOverlay{background:rgba(0,0,0,0.5)}
.bbMenuOverlay.open{opacity:1;visibility:visible}
.bbMenuPanel{
    position:fixed;
    top:44px;
    right:var(--sp-md);
    background:var(--surface);
    border-radius:var(--sp-md);
    box-shadow:0 4px 20px rgba(0,0,0,0.15);
    min-width:180px;
    transform:scale(0.95);
    opacity:0;
    transition:transform 0.15s ease-in-out,opacity 0.15s ease-in-out;
    z-index:101;
    overflow:hidden;
}
.dark .bbMenuPanel{box-shadow:0 4px 20px rgba(0,0,0,0.4)}
.bbMenuOverlay.open .bbMenuPanel{transform:scale(1);opacity:1}
.bbMenuItem{
    display:block;
    width:100%;
    padding:var(--sp-md) var(--sp-lg);
    font-size:var(--fs-md);
    font-weight:400;
    text-align:left;
    border:none;
    background:none;
    color:var(--text);
    cursor:pointer;
    border-bottom:0.5px solid var(--divider);
}
.bbMenuItem:last-child{border-bottom:none}
.bbMenuItem:active{background:var(--bg)}
.bbMenuItem.destructive{color:var(--red)}
</style></head>
<body>

<div class="bbDeviceFrame">
<div class="bbDeviceScreen">

<div class="bbStatusBar">
    <div class="bbStatusBar__left">9:41</div>
    <div class="bbStatusBar__center"></div>
    <div class="bbStatusBar__right">
        <svg viewBox="0 0 17 12"><path d="M15.5 4h-1a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zM16.5 5v2a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5z"/><rect x="0" y="1" width="3" height="10" rx="1" opacity=".3"/><rect x="4" y="1" width="3" height="10" rx="1" opacity=".3"/><rect x="8" y="1" width="3" height="10" rx="1"/><rect x="12" y="1" width="3" height="10" rx="1"/></svg>
        <span>LTE</span>
        <svg viewBox="0 0 25 12"><rect x="0" y="0" width="22" height="12" rx="3" stroke="currentColor" stroke-width="1" fill="none" opacity=".35"/><rect x="23" y="4" width="2" height="4" rx="1" opacity=".4"/><rect x="2" y="2" width="18" height="8" rx="1.5" fill="currentColor"/></svg>
    </div>
</div>

<header class="bbTopbar">
    <button class="bbBrandToggle" id="brandToggle" aria-label="Toggle theme">
        <span class="bbBrand">Blackbox</span>
        <span class="bbModeLabel" id="modeLabel">Bright</span>
        <span class="bbModeIcon" aria-hidden="true">◐</span>
    </button>
    <div class="bbTopRight">
        <div class="bbStatusCluster">
            <span class="bbStatusItem"><span class="bbHigh">High</span>&nbsp;Confidence</span>
            <span class="bbStatusItem"><span class="bbDot"></span>GPS</span>
            <span class="bbStatusItem"><span class="bbDot"></span>IMU</span>
        </div>
        <button class="bbKebab" id="menu-btn" aria-label="Menu">⋮</button>
    </div>
</header>

<main class="bbApp">
    <section class="bbCard bbGCard">
        <div class="bbGReadoutRow bbGReadoutRow--top">
            <div class="bbGReadoutCol">
                <div class="bbGReadoutVal bbNum"><span id="speed">0</span><span class="bbGUnit">km/h</span></div>
                <div class="bbMaxRow">
                    <span class="bbMaxItem"><span class="bbMaxVal bbNum" id="max-speed">0</span><span class="bbMaxLbl" id="max-speed-lbl">max</span></span>
                </div>
            </div>
            <div class="bbGReadoutCol">
                <div class="bbGReadoutVal bbManeuver" id="maneuver">IDLE</div>
            </div>
        </div>

        <div class="bbGPlotWrap">
            <div class="bbGPlotFrame">
                <div class="bbAxis bbAxis--top">Brake</div>
                <div class="bbAxis bbAxis--bottom">Accel</div>
                <div class="bbAxis bbAxis--left">L</div>
                <div class="bbAxis bbAxis--right">R</div>
                <div class="bbPlotMeta" id="range-val">Range ±0.5g</div>
                <canvas class="bbGPlot" id="gcanvas"></canvas>
            </div>
        </div>

        <div class="bbGReadoutRow">
            <div class="bbGReadoutCol">
                <div class="bbGReadoutLbl">Lat</div>
                <div class="bbGReadoutVal bbNum" id="lat-g"><span class="bbSign">+</span><span class="bbVal">0.00</span><span class="bbGUnit">g</span></div>
                <div class="bbMaxRow">
                    <span class="bbMaxItem"><span class="bbMaxSign" id="sign-l">−</span><span class="bbMaxVal bbNum" id="max-l">0.00</span></span>
                    <span class="bbMaxItem"><span class="bbMaxSign" id="sign-r">+</span><span class="bbMaxVal bbNum" id="max-r">0.00</span></span>
                </div>
            </div>
            <div class="bbGDivider"></div>
            <div class="bbGReadoutCol">
                <div class="bbGReadoutLbl">Long</div>
                <div class="bbGReadoutVal bbNum" id="lon-g"><span class="bbSign">+</span><span class="bbVal">0.00</span><span class="bbGUnit">g</span></div>
                <div class="bbMaxRow">
                    <span class="bbMaxItem"><span class="bbMaxSign" id="sign-a">+</span><span class="bbMaxVal bbNum" id="max-a">0.00</span></span>
                    <span class="bbMaxItem"><span class="bbMaxSign" id="sign-b">−</span><span class="bbMaxVal bbNum" id="max-b">0.00</span></span>
                </div>
            </div>
            <div class="bbGDivider"></div>
            <div class="bbGReadoutCol">
                <div class="bbGReadoutLbl">Yaw</div>
                <div class="bbGReadoutVal bbNum" id="yaw-main"><span class="bbSign">+</span><span class="bbYawPad"></span><span class="bbVal">0</span><span class="bbGUnit">°</span></div>
                <div class="bbMaxRow">
                    <span class="bbMaxItem"><span class="bbMaxSign" id="sign-yaw-l">−</span><span class="bbMaxVal bbNum" id="max-yaw-l">0</span></span>
                    <span class="bbMaxItem"><span class="bbMaxSign" id="sign-yaw-r">+</span><span class="bbMaxVal bbNum" id="max-yaw-r">0</span></span>
                </div>
            </div>
        </div>
    </section>

    <div class="bbTelemetryStrip">
        <div class="bbTCluster">
            <span class="bbTItem"><span class="bbNum" id="session-time">0:00</span></span>
        </div>
        <div class="bbTDivider"></div>
        <div class="bbTCluster">
            <span class="bbTItem"><span class="bbNum bbNum--hz" id="hz">30</span>Hz</span>
            <span class="bbTItem"><span class="bbNum bbNum--drops" id="drops">0</span>drops</span>
        </div>
        <div class="bbTDivider"></div>
        <div class="bbTCluster">
            <span class="bbTItem">GPS <span class="bbNum bbNum--gps" id="gps-acc">2</span>m</span>
        </div>
    </div>

    <button class="bbClearBtn" id="clear-btn">Clear Session</button>
</main>

<div class="bbMenuOverlay" id="menu-overlay">
    <div class="bbMenuPanel">
        <button class="bbMenuItem" id="menu-rec">Start Recording</button>
        <button class="bbMenuItem" id="menu-export">Export CSV</button>
        <button class="bbMenuItem destructive" id="menu-clear">Clear Session</button>
    </div>
</div>

<div class="bbHomeIndicator">
    <div class="bbHomeIndicator__bar"></div>
</div>

<script>
const CANYON_KEYFRAMES = [
    [0,      55,    0.15,  0.05,  3],
    [2000,   70,    0.30,  0.02,  1],
    [3500,   75,    0.10,  0.05,  5],
    [4500,   68,   -0.35,  0.10,  8],
    [5500,   55,   -0.20,  0.35,  25],
    [7000,   52,    0.05,  0.45,  32],
    [8500,   58,    0.25,  0.30,  20],
    [10000,  70,    0.30,  0.10,  6],
    [11500,  78,    0.15,  0.02,  0],
    [13000,  72,   -0.40,  -0.05, -3],
    [14500,  55,   -0.25,  -0.40, -30],
    [16500,  45,    0.05,  -0.55, -40],
    [18500,  50,    0.30,  -0.40, -28],
    [20000,  62,    0.25,  -0.15, -10],
    [21500,  65,    0.10,  0.25,  18],
    [22500,  60,    0.05,  -0.20, -15],
    [23500,  62,    0.15,  0.20,  14],
    [25000,  72,    0.30,  0.05,  2],
    [26500,  78,   -0.25,  -0.10, -8],
    [28000,  65,    0.05,  -0.42, -32],
    [30000,  55,    0.15,  0.05,  3],
];
const LOOP_DURATION = 30000;

const $ = id => document.getElementById(id);
const MODES = {0:'IDLE', 1:'ACCEL', 2:'BRAKE', 4:'CORNER', 5:'CORNER EXIT', 6:'TRAIL BRAKING'};
const MODE_COLORS = {
    0: 'var(--mode-idle)',
    1: 'var(--mode-accel)',
    2: 'var(--mode-brake)',
    4: 'var(--mode-idle)',
    5: 'var(--mode-accel)',
    6: 'var(--mode-brake)'
};

function getModeColorsHex() {
    return {
        0: isDark ? '#ffffff' : '#1c1c1e',
        1: isDark ? '#ffffff' : '#1c1c1e',
        2: '#ff3b30',
        4: isDark ? '#ffffff' : '#1c1c1e',
        5: isDark ? '#ffffff' : '#1c1c1e',
        6: '#ff3b30'
    };
}

let currentModeColor = '#8e8e93';
let isSettingAnyMax = false;
let anyMaxTimeout = null;

function catmullRom(p0, p1, p2, p3, t) {
    const t2 = t * t, t3 = t2 * t;
    return 0.5 * ((2 * p1) + (-p0 + p2) * t + (2 * p0 - 5 * p1 + 4 * p2 - p3) * t2 + (-p0 + 3 * p1 - 3 * p2 + p3) * t3);
}

function getKeyframeInterp(timeMs) {
    const loopTime = timeMs % LOOP_DURATION;
    let i1 = 0;
    for (let i = 0; i < CANYON_KEYFRAMES.length - 1; i++) {
        if (loopTime >= CANYON_KEYFRAMES[i][0] && loopTime < CANYON_KEYFRAMES[i + 1][0]) { i1 = i; break; }
    }
    const kf0 = CANYON_KEYFRAMES[(i1 - 1 + CANYON_KEYFRAMES.length) % CANYON_KEYFRAMES.length];
    const kf1 = CANYON_KEYFRAMES[i1];
    const kf2 = CANYON_KEYFRAMES[(i1 + 1) % CANYON_KEYFRAMES.length];
    const kf3 = CANYON_KEYFRAMES[(i1 + 2) % CANYON_KEYFRAMES.length];
    const segDur = (kf2[0] - kf1[0] + LOOP_DURATION) % LOOP_DURATION || LOOP_DURATION;
    const t = Math.max(0, Math.min(1, (loopTime - kf1[0]) / segDur));
    return { kf0, kf1, kf2, kf3, t };
}

function getAutoValues(timeMs) {
    const { kf0, kf1, kf2, kf3, t } = getKeyframeInterp(timeMs);
    return {
        speed: catmullRom(kf0[1], kf1[1], kf2[1], kf3[1], t),
        lonG: catmullRom(kf0[2], kf1[2], kf2[2], kf3[2], t),
        latG: catmullRom(kf0[3], kf1[3], kf2[3], kf3[3], t),
        yawDeg: catmullRom(kf0[4], kf1[4], kf2[4], kf3[4], t)
    };
}

function addNoise(val, amount) { return val + (Math.random() - 0.5) * amount * 0.15; }

let loopStartTime = Date.now();
let sessionStart = Date.now();
let rec = false, data = [], cnt = 0, drops = 0;
let trail = [], maxL = 0, maxR = 0, maxA = 0, maxB = 0, maxYawL = 0, maxYawR = 0, peak = 0;
let emaGx = 0, emaGy = 0, lastT = 0, speed_ema = 0;
const EMA_TAU = 0.10;
const TRAIL_DURATION_MS = 4000;
const TRAIL_MAX_POINTS = 60;
const TRAIL_JITTER_THRESHOLD = 0.008;

// G-envelope: track max magnitude in each angular direction
const ENVELOPE_SEGMENTS = 72; // 5-degree resolution
let gEnvelope = new Array(ENVELOPE_SEGMENTS).fill(0);

function updateEnvelope(gx, gy) {
    const mag = Math.sqrt(gx * gx + gy * gy);
    if (mag < 0.02) return; // ignore noise near center
    let angle = Math.atan2(gy, gx); // radians, -PI to PI
    if (angle < 0) angle += Math.PI * 2; // convert to 0 to 2PI
    const segment = Math.floor(angle / (Math.PI * 2) * ENVELOPE_SEGMENTS) % ENVELOPE_SEGMENTS;
    if (mag > gEnvelope[segment]) {
        gEnvelope[segment] = mag;
    }
}

const SCALE_STEPS = [0.3, 0.5, 0.8, 1.0, 1.5, 2.0];
let currentScale = 0.5;

let config = { acc_thr: 0.22, acc_exit: 0.11, brake_thr: 0.35, brake_exit: 0.17, lat_thr: 0.28, lat_exit: 0.14, yaw_thr: 0.10, min_speed: 3.0, alpha: 0.35 };
let emaLat = 0, emaYaw = 0, inAccel = false, inBrake = false, inCorner = false;

function classifyMode(lonG, latG, yawRad, speedMs) {
    emaLat = config.alpha * Math.abs(latG) + (1 - config.alpha) * emaLat;
    emaYaw = config.alpha * Math.abs(yawRad) + (1 - config.alpha) * emaYaw;
    if (speedMs < config.min_speed) { inAccel = inBrake = inCorner = false; return 0; }
    if (lonG > config.acc_thr) inAccel = true; else if (lonG < config.acc_exit) inAccel = false;
    if (lonG < -config.brake_thr) inBrake = true; else if (lonG > -config.brake_exit) inBrake = false;
    const signConsistent = (latG * yawRad) > 0;
    if (emaLat > config.lat_thr && emaYaw > config.yaw_thr && signConsistent) inCorner = true;
    else if (emaLat < config.lat_exit || emaYaw < config.yaw_thr * 0.5) inCorner = false;
    let mode = 0;
    if (inAccel) mode |= 1; if (inBrake) mode |= 2; if (inCorner) mode |= 4;
    if ((mode & 3) === 3) mode &= ~2;
    return mode;
}

let isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
function applyTheme() {
    document.querySelector('.bbDeviceScreen').classList.toggle('dark', isDark);
    $('modeLabel').textContent = isDark ? 'Dark' : 'Bright';
}
applyTheme();

$('brandToggle').onclick = () => { isDark = !isDark; applyTheme(); };

const cv = $('gcanvas');
const ctx = cv.getContext('2d');

function resize() {
    const frame = cv.parentElement;
    const rect = frame.getBoundingClientRect();
    const size = Math.min(rect.width, rect.height);
    cv.width = size * devicePixelRatio;
    cv.height = size * devicePixelRatio;
    cv.style.width = size + 'px';
    cv.style.height = size + 'px';
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(devicePixelRatio, devicePixelRatio);
}
resize();
window.addEventListener('resize', resize);

let magHist = [];
function updateScale(gx, gy) {
    const now = Date.now();
    const mag = Math.sqrt(gx * gx + gy * gy);
    magHist.push({ t: now, m: mag });
    magHist = magHist.filter(h => now - h.t < 1000);
    const peakMag = Math.max(...magHist.map(h => h.m), 0.1);
    const needed = peakMag * 1.4;
    let targetScale = SCALE_STEPS[0];
    for (const step of SCALE_STEPS) {
        if (step >= needed) { targetScale = step; break; }
        targetScale = step;
    }
    if (targetScale > currentScale) currentScale += (targetScale - currentScale) * 0.15;
    else if (targetScale < currentScale) currentScale += (targetScale - currentScale) * 0.03;
    for (const step of SCALE_STEPS) {
        if (Math.abs(currentScale - step) < 0.02) { currentScale = step; break; }
    }
    $('range-val').textContent = 'Range ±' + currentScale.toFixed(1) + 'g';
}

function hexToRgba(hex, a) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r},${g},${b},${a})`;
}

function downsampleTrail(points, maxPoints) {
    if (points.length <= maxPoints) return points;
    const recentCount = Math.min(25, Math.floor(maxPoints * 0.4));
    const recent = points.slice(-recentCount);
    const older = points.slice(0, -recentCount);
    const olderTarget = maxPoints - recentCount;
    const step = Math.ceil(older.length / olderTarget);
    const sampled = older.filter((_, i) => i % step === 0);
    return [...sampled, ...recent];
}

function drawG() {
    const size = cv.width / devicePixelRatio;
    const cx = size / 2, cy = size / 2;
    const r = size * 0.38;

    ctx.clearRect(0, 0, size, size);

    // Draw G-envelope first (underneath everything)
    const hasEnvelope = gEnvelope.some(v => v > 0.02);
    if (hasEnvelope) {
        // Draw envelope path
        ctx.beginPath();
        for (let i = 0; i <= ENVELOPE_SEGMENTS; i++) {
            const idx = i % ENVELOPE_SEGMENTS;
            const angle = (idx / ENVELOPE_SEGMENTS) * Math.PI * 2;
            const mag = gEnvelope[idx];
            const px = cx + Math.cos(angle) * (mag / currentScale) * r;
            const py = cy - Math.sin(angle) * (mag / currentScale) * r;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
        }
        ctx.closePath();
        ctx.fillStyle = isDark ? '#000000' : '#ffffff';
        ctx.fill();

    }

    const ringColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
    const ringColorThick = isDark ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)';
    const axisColor = isDark ? 'rgba(255,255,255,0.66)' : 'rgba(0,0,0,0.66)';

    // Ring lines at fixed G values (absolute, not relative to scale)
    // Light rings at 0.1g increments, main rings at 0.2g, accent rings at 0.5g and 1.0g
    // Keep 20% margin around outermost ring
    const ringColorLight = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
    const ringColorAccent = isDark ? 'rgba(255,255,255,0.33)' : 'rgba(0,0,0,0.33)';
    [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0].forEach((gVal) => {
        const ringRadius = (gVal / currentScale) * r;
        if (ringRadius > r * 0.8) return; // keep 20% empty around outermost ring
        const isAccent = gVal === 0.5 || gVal === 1.0;
        const isMain = gVal % 0.2 < 0.01 && !isAccent;
        ctx.lineWidth = isAccent ? 2 : 1;
        ctx.strokeStyle = isAccent ? ringColorAccent : (isMain ? ringColor : ringColorLight);
        ctx.beginPath();
        ctx.arc(cx, cy, ringRadius, 0, Math.PI * 2);
        ctx.stroke();
    });

    // Axis lines
    ctx.strokeStyle = axisColor;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(cx - r, cy); ctx.lineTo(cx + r, cy);
    ctx.moveTo(cx, cy - r); ctx.lineTo(cx, cy + r);
    ctx.stroke();

    ctx.fillStyle = isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)';
    ctx.beginPath();
    ctx.arc(cx, cy, 2, 0, Math.PI * 2);
    ctx.fill();

    const now = Date.now();
    const recentTrail = trail.filter(p => now - p.t < TRAIL_DURATION_MS);
    const displayTrail = downsampleTrail(recentTrail, TRAIL_MAX_POINTS);

    if (displayTrail.length > 1) {
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        for (let i = 1; i < displayTrail.length; i++) {
            const p0 = displayTrail[i - 1];
            const p1 = displayTrail[i];
            const age = (now - p1.t) / TRAIL_DURATION_MS;
            const alpha = Math.max(0.1, 0.6 * (1 - age * 0.8));
            const trailColor = isSettingAnyMax ? '#ff9500' : currentModeColor;
            ctx.strokeStyle = hexToRgba(trailColor, alpha);
            ctx.lineWidth = 1.5 - age * 0.6;
            ctx.beginPath();
            const x0 = cx + (p0.x / currentScale) * r;
            const y0 = cy - (p0.y / currentScale) * r;
            const x1 = cx + (p1.x / currentScale) * r;
            const y1 = cy - (p1.y / currentScale) * r;
            ctx.moveTo(x0, y0);
            ctx.lineTo(x1, y1);
            ctx.stroke();
        }
    }

    if (trail.length > 0) {
        const cur = trail[trail.length - 1];
        const x = cx + (cur.x / currentScale) * r;
        const y = cy - (cur.y / currentScale) * r;
        const crossSize = 8;
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(x - crossSize, y);
        ctx.lineTo(x + crossSize, y);
        ctx.moveTo(x, y - crossSize);
        ctx.lineTo(x, y + crossSize);
        ctx.stroke();
    }
}

function fmtGSigned(v) {
    const sign = v >= 0 ? '+' : '−';
    return { sign, num: Math.abs(v).toFixed(2) };
}

function fmtTime(ms) {
    const s = Math.floor(ms / 1000);
    const m = Math.floor(s / 60);
    return m + ':' + String(s % 60).padStart(2, '0');
}

function updateModeDisplay(mo) {
    const name = MODES[mo] || 'IDLE';
    const color = MODE_COLORS[mo] || MODE_COLORS[0];
    const hexColors = getModeColorsHex();
    currentModeColor = hexColors[mo] || hexColors[0];
    const el = $('maneuver');
    el.textContent = name;
    el.style.color = color;
}

function updateReadouts(lat, lon, yawDeg) {
    const latFmt = fmtGSigned(lat);
    const lonFmt = fmtGSigned(lon);
    const yawSign = yawDeg >= 0 ? '+' : '−';
    const yawVal = Math.round(Math.abs(yawDeg));
    const yawPad = yawVal < 10 ? '<span class="bbYawPad">0</span>' : '';
    $('lat-g').innerHTML = `<span class="bbSign">${latFmt.sign}</span><span class="bbVal">${latFmt.num}</span><span class="bbGUnit">g</span>`;
    $('lon-g').innerHTML = `<span class="bbSign">${lonFmt.sign}</span><span class="bbVal">${lonFmt.num}</span><span class="bbGUnit">g</span>`;
    $('yaw-main').innerHTML = `<span class="bbSign">${yawSign}</span>${yawPad}<span class="bbVal">${yawVal}</span><span class="bbGUnit">°</span>`;
}

let maxLTimeout = null, maxRTimeout = null, maxATimeout = null, maxBTimeout = null, maxYawLTimeout = null, maxYawRTimeout = null;

function showNewMax(elId, signId, value, formatFn, timeoutRef, mainReadoutId) {
    // Skip max highlighting during first 10 seconds
    if (Date.now() - sessionStart < 10000) {
        $(elId).textContent = formatFn(value);
        return;
    }
    const el = $(elId);
    const signEl = signId ? $(signId) : null;
    const mainEl = mainReadoutId ? $(mainReadoutId) : null;
    const isSpeedMax = elId === 'max-speed';
    el.textContent = 'max';
    el.classList.add('setting');
    if (signEl) {
        if (isSpeedMax) signEl.style.display = 'none';
        else signEl.classList.add('hidden');
    }
    if (mainEl) mainEl.classList.add('peak');
    isSettingAnyMax = true;
    if (anyMaxTimeout) clearTimeout(anyMaxTimeout);
    if (timeoutRef.current) clearTimeout(timeoutRef.current);
    timeoutRef.current = setTimeout(() => {
        el.textContent = formatFn(value);
        el.classList.remove('setting');
        if (signEl) {
            if (isSpeedMax) signEl.style.display = '';
            else signEl.classList.remove('hidden');
        }
        if (mainEl) mainEl.classList.remove('peak');
    }, 900);
    anyMaxTimeout = setTimeout(() => { isSettingAnyMax = false; }, 900);
}
const maxLRef = {current:null}, maxRRef = {current:null}, maxARef = {current:null}, maxBRef = {current:null}, maxYawLRef = {current:null}, maxYawRRef = {current:null}, maxSpeedRef = {current:null};

function simulate() {
    const elapsed = Date.now() - loopStartTime;
    const auto = getAutoValues(elapsed);
    const sp = addNoise(auto.speed, 2);
    const longRaw = addNoise(auto.lonG, 0.02);
    const latRaw = addNoise(auto.latG, 0.02);
    const yawDegSigned = addNoise(auto.yawDeg, 1);
    const yawDeg = Math.abs(yawDegSigned);
    const yawRad = auto.yawDeg * Math.PI / 180;
    const speedMs = sp / 3.6;

    const mo = classifyMode(longRaw, latRaw, yawRad, speedMs);

    speed_ema = 0.7 * sp + 0.3 * speed_ema;
    const dspd = speed_ema < 1 ? 0 : Math.round(speed_ema);

    const now = Date.now();
    const dt = lastT ? Math.min((now - lastT) / 1000, 0.2) : 0.033;
    lastT = now;
    const alpha = 1 - Math.exp(-dt / EMA_TAU);

    emaGx = alpha * latRaw + (1 - alpha) * emaGx;
    emaGy = alpha * longRaw + (1 - alpha) * emaGy;

    const mag = Math.sqrt(emaGx * emaGx + emaGy * emaGy);
    const noise = speed_ema < 5 ? 0.04 : 0.015;
    const lat = mag < noise ? 0 : emaGx;
    const lon = mag < noise ? 0 : emaGy;

    const speedEl = $('speed');
    if (dspd > peak) {
        peak = dspd;
        showNewMax('max-speed', 'max-speed-lbl', peak, v => v, maxSpeedRef, 'speed');
    }
    speedEl.textContent = dspd;

    updateModeDisplay(mo);
    updateReadouts(lat, lon, yawDegSigned);

    if (latRaw < 0 && Math.abs(latRaw) > maxL) { maxL = Math.abs(latRaw); showNewMax('max-l', 'sign-l', maxL, v => v.toFixed(2), maxLRef, 'lat-g'); }
    if (latRaw > 0 && latRaw > maxR) { maxR = latRaw; showNewMax('max-r', 'sign-r', maxR, v => v.toFixed(2), maxRRef, 'lat-g'); }
    if (longRaw > 0 && longRaw > maxA) { maxA = longRaw; showNewMax('max-a', 'sign-a', maxA, v => v.toFixed(2), maxARef, 'lon-g'); }
    if (longRaw < 0 && Math.abs(longRaw) > maxB) { maxB = Math.abs(longRaw); showNewMax('max-b', 'sign-b', maxB, v => v.toFixed(2), maxBRef, 'lon-g'); }
    if (yawDegSigned < 0 && Math.abs(yawDegSigned) > maxYawL) { maxYawL = Math.abs(yawDegSigned); showNewMax('max-yaw-l', 'sign-yaw-l', maxYawL, v => Math.round(v), maxYawLRef, 'yaw-main'); }
    if (yawDegSigned > 0 && yawDegSigned > maxYawR) { maxYawR = yawDegSigned; showNewMax('max-yaw-r', 'sign-yaw-r', maxYawR, v => Math.round(v), maxYawRRef, 'yaw-main'); }

    // Update G-envelope with current values
    updateEnvelope(lat, lon);

    if (speed_ema >= 2) {
        updateScale(lat, lon);
    } else {
        magHist = [];
        currentScale = SCALE_STEPS[0];
        $('range-val').textContent = 'Range ±' + currentScale.toFixed(1) + 'g';
    }

    const lastPt = trail.length > 0 ? trail[trail.length - 1] : null;
    const dx = lastPt ? Math.abs(lat - lastPt.x) : 1;
    const dy = lastPt ? Math.abs(lon - lastPt.y) : 1;
    if (!lastPt || dx > TRAIL_JITTER_THRESHOLD || dy > TRAIL_JITTER_THRESHOLD) {
        trail.push({ x: lat, y: lon, t: now });
    }
    trail = trail.filter(p => now - p.t < TRAIL_DURATION_MS + 200);
    drawG();

    cnt++;
    if (rec) data.push({ t: now, sp, ax: -longRaw * 9.81, ay: latRaw * 9.81, wz: yawRad, mo, latg: latRaw, lng: longRaw, lat: 37.82, lon: -122.48, gpsOk: 1 });
}

setInterval(simulate, 33);

setInterval(() => {
    $('hz').textContent = cnt;
    cnt = 0;
    $('session-time').textContent = fmtTime(Date.now() - sessionStart);
    $('gps-acc').textContent = '2';
    $('drops').textContent = drops;
}, 1000);

$('menu-btn').onclick = () => $('menu-overlay').classList.add('open');
$('menu-overlay').onclick = e => { if (e.target === $('menu-overlay')) $('menu-overlay').classList.remove('open'); };

$('menu-rec').onclick = () => {
    rec = !rec;
    $('menu-overlay').classList.remove('open');
    if (rec) { data = []; sessionStart = Date.now(); $('menu-rec').textContent = 'Stop Recording'; }
    else {
        $('menu-rec').textContent = 'Start Recording';
        if (data.length) {
            const s = JSON.parse(localStorage.getItem('bb') || '[]');
            s.unshift({ id: Date.now(), n: data.length, d: data });
            localStorage.setItem('bb', JSON.stringify(s.slice(0, 10)));
            alert('Saved ' + data.length + ' points');
        }
    }
};

$('menu-export').onclick = () => {
    $('menu-overlay').classList.remove('open');
    const s = JSON.parse(localStorage.getItem('bb') || '[]');
    if (!s.length) return alert('No recorded data');
    let csv = 'time,speed,ax,ay,wz,mode,lat_g,lon_g,gps_lat,gps_lon,gps_valid\n';
    s[0].d.forEach(r => { csv += [r.t, r.sp, r.ax, r.ay, r.wz, r.mo, r.latg, r.lng, r.lat||0, r.lon||0, r.gpsOk||0].join(',') + '\n'; });
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'blackbox_session.csv'; a.click();
};

function clearSession() {
    $('menu-overlay').classList.remove('open');
    maxL = maxR = maxA = maxB = maxYawL = maxYawR = peak = drops = 0;
    $('max-l').textContent = $('max-r').textContent = $('max-a').textContent = $('max-b').textContent = '0.00';
    $('max-yaw-l').textContent = $('max-yaw-r').textContent = '0';
    $('max-speed').textContent = '0';
    $('max-speed').classList.remove('setting');
    $('max-speed-lbl').style.display = '';
    ['max-l','max-r','max-a','max-b','max-yaw-l','max-yaw-r'].forEach(id => $(id).classList.remove('setting'));
    ['sign-l','sign-r','sign-a','sign-b','sign-yaw-l','sign-yaw-r'].forEach(id => $(id).classList.remove('hidden'));
    $('speed').classList.remove('peak');
    trail = []; magHist = []; currentScale = SCALE_STEPS[0];
    gEnvelope = new Array(ENVELOPE_SEGMENTS).fill(0);
    $('range-val').textContent = 'Range ±' + currentScale.toFixed(1) + 'g';
    emaGx = emaGy = 0; sessionStart = Date.now(); loopStartTime = Date.now();
}

$('menu-clear').onclick = clearSession;
$('clear-btn').onclick = clearSession;

setTimeout(() => { resize(); drawG(); }, 50);
</script>

</div>
</div>
</body></html>
