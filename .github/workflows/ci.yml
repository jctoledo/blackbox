name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Check framework and drivers
        run: |
          # Build exclusion list for all sensor projects (they need ESP32 target)
          EXCLUDES=""
          for sensor_dir in sensors/*/; do
            if [ -f "${sensor_dir}Cargo.toml" ]; then
              sensor_name=$(basename "$sensor_dir")
              EXCLUDES="$EXCLUDES --exclude $sensor_name"
            fi
          done

          echo "Checking workspace (excluding sensor projects)..."
          cargo check --workspace $EXCLUDES --all-features

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Run clippy on framework and drivers
        run: |
          # Build exclusion list for all sensor projects
          EXCLUDES=""
          for sensor_dir in sensors/*/; do
            if [ -f "${sensor_dir}Cargo.toml" ]; then
              sensor_name=$(basename "$sensor_dir")
              EXCLUDES="$EXCLUDES --exclude $sensor_name"
            fi
          done

          echo "Running clippy (excluding sensor projects)..."
          cargo clippy --workspace $EXCLUDES --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run tests on framework and drivers
        run: |
          # Build exclusion list for all sensor projects
          EXCLUDES=""
          for sensor_dir in sensors/*/; do
            if [ -f "${sensor_dir}Cargo.toml" ]; then
              sensor_name=$(basename "$sensor_dir")
              EXCLUDES="$EXCLUDES --exclude $sensor_name"
            fi
          done

          echo "Running tests (excluding sensor projects)..."
          cargo test --workspace $EXCLUDES

  build-sensor-projects:
    name: Build Sensor Projects
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rust-src

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf python3 python3-pip python3-venv \
            cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0 libudev-dev

      - name: Install ldproxy and cargo-espflash
        run: cargo install ldproxy cargo-espflash

      - name: Discover and build all sensor projects
        run: |
          # Find all sensor projects (directories with Cargo.toml in sensors/)
          build_count=0
          failed_count=0

          for sensor_dir in sensors/*/; do
            if [ -f "${sensor_dir}Cargo.toml" ]; then
              sensor_name=$(basename "$sensor_dir")
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
              echo "Building sensor project: $sensor_name"
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

              # Build from the sensor directory to use its .cargo/config.toml
              # The embuild system will download ESP-IDF automatically
              if (cd "$sensor_dir" && cargo build --release); then
                echo "✅ Successfully built $sensor_name"
                ((build_count++))
              else
                echo "❌ Failed to build $sensor_name"
                ((failed_count++))
              fi
            fi
          done

          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Build Summary:"
          echo "  ✅ Successful: $build_count"
          echo "  ❌ Failed: $failed_count"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          # Fail the job if any builds failed
          if [ $failed_count -gt 0 ]; then
            exit 1
          fi

      - name: Collect firmware binaries
        id: collect_binaries
        run: |
          # Create a directory to collect all sensor binaries
          mkdir -p firmware-artifacts

          # Find and copy all sensor project binaries
          # The binary is in sensors/<name>/target/<target>/release/<name>
          for sensor_dir in sensors/*/; do
            if [ -f "${sensor_dir}Cargo.toml" ]; then
              sensor_name=$(basename "$sensor_dir")

              # Find the binary in the sensor's target directory
              binary_path="${sensor_dir}target/riscv32imc-esp-espidf/release/$sensor_name"

              if [ -f "$binary_path" ]; then
                echo "✅ Found binary: $sensor_name"
                cp "$binary_path" "firmware-artifacts/"
                ls -lh "$binary_path"
              else
                echo "⚠️  Binary not found: $binary_path"
                # Try alternate location (workspace target dir)
                alt_path="target/riscv32imc-esp-espidf/release/$sensor_name"
                if [ -f "$alt_path" ]; then
                  echo "✅ Found binary at: $alt_path"
                  cp "$alt_path" "firmware-artifacts/"
                fi
              fi
            fi
          done

          echo ""
          echo "Firmware artifacts collected:"
          ls -lh firmware-artifacts/ || echo "No binaries found"

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sensor-firmware-${{ matrix.target }}
          path: firmware-artifacts/
          if-no-files-found: error

  python-lint:
    name: Python Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black

          # Install requirements from all sensor projects that have them
          for sensor_dir in sensors/*/; do
            if [ -f "${sensor_dir}tools/python/requirements.txt" ]; then
              echo "Installing Python requirements for $(basename "$sensor_dir")..."
              pip install -r "${sensor_dir}tools/python/requirements.txt"
            fi
          done

      - name: Lint Python tools with flake8
        run: |
          # Find all sensor projects with Python tools
          python_dirs=$(find sensors/*/tools/python -type d 2>/dev/null || true)

          if [ -z "$python_dirs" ]; then
            echo "No Python tools found in any sensor projects"
            exit 0
          fi

          # Lint each Python tools directory
          for py_dir in $python_dirs; do
            if [ -d "$py_dir" ] && [ "$(ls -A $py_dir/*.py 2>/dev/null)" ]; then
              sensor_name=$(echo "$py_dir" | cut -d'/' -f2)
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
              echo "Linting Python tools for: $sensor_name"
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

              # Stop on syntax errors or undefined names
              flake8 "$py_dir" --count --select=E9,F63,F7,F82 --show-source --statistics

              # Exit-zero treats all errors as warnings
              flake8 "$py_dir" --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics
            fi
          done

      - name: Check Python formatting with black
        run: |
          # Find all Python files in sensor tools directories
          python_files=$(find sensors/*/tools/python -name "*.py" 2>/dev/null || true)

          if [ -z "$python_files" ]; then
            echo "No Python files found in sensor projects"
            exit 0
          fi

          echo "Checking formatting for Python files..."
          black --check $python_files
